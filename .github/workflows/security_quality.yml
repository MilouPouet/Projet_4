name: CI/CD Sécurité et Qualité (Python) # Nom visible sur GitHub Actions

# SECTION DÉCLENCHEURS : S'exécute sur push ou PR vers la branche main
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# PERMISSIONS : Essentiel pour que ZAP puisse créer des rapports/issues
permissions:
  contents: read
  issues: write

jobs:
  # --- JOB 1 : SÉCURITÉ STATIQUE (Gitleaks, Bandit, Safety) ---
  static_security:
    name: Sécurité (Secrets, Code, Dépendances)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important pour Gitleaks (scan de l'historique)

      # 1. Gitleaks : Détection de mots de passe ou clés API en clair
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 2. Bandit : Analyse des failles de sécurité dans le code Python
      - name: Install Bandit
        run: pip install bandit
      - name: Run Bandit
        run: bandit -r . -x ./tests -v

      # 3. Safety : Vérifie si vos librairies (requirements.txt) sont vulnérables
      - name: Install Safety
        run: pip install safety
      - name: Run Safety Check
        run: safety check -r requirements.txt

  # --- JOB 2 : QUALITÉ DU CODE (SonarCloud) ---
  sonarcloud_scan:
    name: Analyse de Qualité SonarCloud
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Installation des dépendances
        run: pip install -r requirements.txt

      - name: Lancement du Scan SonarCloud
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          organization: miloupouetpouet
          projectKey: MilouPouet_Projet_4

  # --- JOB 3 : SÉCURITÉ DYNAMIQUE (OWASP ZAP) ---
  zap_scan:
    name: Scan de Sécurité OWASP ZAP (Baseline)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 

      - name: Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Installation des dépendances
        run: pip install -r requirements.txt

      - name: Démarrage du Serveur Python pour ZAP
        run: |
          # On lance l'application en arrière-plan
          nohup python web_app.py & 
          # On attend que le serveur soit prêt (45 sec)
          sleep 45 

      - name: Lancement du ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0 
        with:
          target: 'http://127.0.0.1:8080' # Doit correspondre au port de web_app.py
          fail_action: false # Ne bloque pas le pipeline en cas d'alerte (pour analyse)
          artifact_name: 'zap-scan-report'