name: CI/CD Sécurité et Qualité (Python)

# Déclenchement automatique à chaque push ou demande de fusion (Pull Request)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Autorisations nécessaires pour générer des rapports et écrire des alertes
permissions:
  contents: read
  issues: write

jobs:
  # --- ANALYSE STATIQUE (SAST) ---
  # Objectif : Trouver les failles dans le code avant qu'il ne soit exécuté.
  static_security:
    name: Sécurité (Secrets, Code, Dépendances)
    runs-on: ubuntu-latest
    steps:
      - name: Récupération du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # GITLEAKS : Détecte les mots de passe, clés API ou tokens oubliés dans le code.
      - name: Scan des Secrets (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # BANDIT : Cherche les failles spécifiques à Python (ex: debug=True, injection).
      # Le flag '-lll' empêche le blocage pour les alertes mineures (Low/Medium).
      - name: Analyse du code Python (Bandit)
        run: |
          pip install bandit
          bandit -r . -x ./tests -v -lll

      # SAFETY : Vérifie si les librairies installées (via requirements.txt) sont piratées ou vulnérables.
      - name: Sécurité des Librairies (Safety)
        run: |
          pip install safety
          safety check -r requirements.txt

  # --- QUALITÉ DU CODE ---
  # Objectif : Vérifier que le code est propre, maintenable et sans bugs logiques.
  sonarcloud_scan:
    name: Analyse de Qualité SonarCloud
    runs-on: ubuntu-latest
    steps:
      - name: Récupération du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Installation environnement & dépendances
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Installation des librairies
        run: pip install -r requirements.txt

      # SONARCLOUD : Le "professeur" qui note la propreté de ton code.
      - name: Scan Qualité (SonarCloud)
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          organization: miloupouetpouet
          projectKey: MilouPouet_Projet_4

  # --- ANALYSE DYNAMIQUE (DAST) ---
  # Objectif : Tester l'application "en vie" contre de vraies tentatives de piratage.
  zap_scan:
    name: Scan de Sécurité OWASP ZAP (Baseline)
    runs-on: ubuntu-latest
    steps:
      - name: Récupération du code
        uses: actions/checkout@v4 

      - name: Préparation du serveur de test
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Installation des dépendances
        run: pip install -r requirements.txt

      # On lance l'app web en arrière-plan pour que le scanner puisse l'attaquer.
      - name: Lancement de l'application
        run: |
          nohup python web_app.py & 
          sleep 45 

      # OWASP ZAP : Simule des attaques de hacker sur le site lancé.
      - name: Scan d'Attaque (OWASP ZAP)
        uses: zaproxy/action-baseline@v0.14.0 
        with:
          target: 'http://127.0.0.1:8080'
          fail_action: false # Ne bloque pas si une alerte mineure est trouvée
          artifact_name: 'zap-scan-report'